<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento Espaço CN</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilo base para o corpo da página */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Cinza escuro para o fundo */
        }
        /* Efeito de transição suave para as etapas do formulário */
        .form-step {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            min-height: 500px;
        }
        .form-step.hidden {
            opacity: 0;
            transform: translateX(20px);
            position: absolute;
            width: 100%;
            pointer-events: none;
        }
        /* Estilo para a barra de progresso */
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Estilo para o campo "Outro" que aparece */
        #other-space-container {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
        }
        #other-space-container:not(.hidden) {
            max-height: 10rem; /* Altura suficiente para o campo */
            margin-top: 1.5rem; /* Adiciona espaço quando visível */
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div id="form-container" class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl p-6 sm:p-8 md:p-10 transition-all duration-500">
        
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold tracking-tight">Agendamento Espaço CN</h1>
            <p class="text-gray-400 mt-2">Formulário de Reserva</p>
        </div>

        <div id="progress-section" class="mb-8">
            <div class="relative pt-1">
                <div class="flex mb-2 items-center justify-between">
                    <div>
                        <span id="step-name" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-teal-600 bg-teal-200"></span>
                    </div>
                    <div class="text-right">
                        <span id="step-progress-text" class="text-xs font-semibold inline-block text-teal-600"></span>
                    </div>
                </div>
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-gray-700">
                    <div id="progress-bar" class="progress-bar-fill shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-teal-500"></div>
                </div>
            </div>
        </div>

        <form id="booking-form" class="relative overflow-hidden" novalidate>
            <!-- Etapa 1: Informações da Reserva -->
            <div id="step-1" class="form-step">
                <h2 class="text-2xl font-semibold mb-6">Informações da Reserva</h2>
                <div class="space-y-6">
                    <!-- Campos de Nome, Telefone, E-mail, Responsável, Ministério -->
                    <div>
                        <label for="fullName" class="block text-sm font-medium text-gray-300 mb-1">Nome Completo do Solicitante</label>
                        <input type="text" id="fullName" name="fullName" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Seu nome completo" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-300 mb-1">Telefone/WhatsApp</label>
                        <input type="tel" id="phone" name="phone" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="(XX) XXXXX-XXXX" required>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-300 mb-1">E-mail</label>
                        <input type="email" id="email" name="email" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="seu.email@exemplo.com" required>
                    </div>
                    <div>
                        <label for="responsibleEmail" class="block text-sm font-medium text-gray-300 mb-1">E-mail do Responsável</label>
                        <input type="email" id="responsibleEmail" name="responsibleEmail" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="email.responsavel@exemplo.com" required>
                    </div>
                     <div>
                        <label for="ministry" class="block text-sm font-medium text-gray-300 mb-1">Ministério/Grupo (Opcional)</label>
                        <input type="text" id="ministry" name="ministry" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Ex: Louvor, Mídia, etc.">
                    </div>
                    <div>
                        <label for="desiredSpace" class="block text-sm font-medium text-gray-300 mb-1">Espaço desejado</label>
                        <select id="desiredSpace" name="desiredSpace" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" required>
                            <option value="" disabled selected>Selecione um espaço</option>
                            <option value="Lounge">Lounge</option>
                            <option value="Templo">Templo</option>
                            <option value="Sala Alta">Sala Alta para até 25 pessoas</option>
                            <option value="Sala ID">Sala ID para até 15 pessoas</option>
                            <option value="Cantina">Reserva de Data para Cantina</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div id="other-space-container" class="hidden">
                        <label for="otherSpace" class="block text-sm font-medium text-gray-300 mb-1">Qual espaço?</label>
                        <input type="text" id="otherSpace" name="otherSpace" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Descreva o espaço desejado">
                    </div>
                </div>
            </div>

            <!-- Etapa 2: Google Calendar -->
            <div id="step-2" class="form-step hidden">
                <h2 class="text-2xl font-semibold mb-6">Agende seu Horário</h2>
                <!-- Google Calendar Appointment Scheduling begin -->
                <div class="bg-white rounded-xl shadow-lg p-2 sm:p-4" style="border: 1px solid #e5e7eb;">
                    <iframe src="https://calendar.google.com/calendar/appointments/schedules/AcZssZ1PT4RhCs68ghRp3byicG8tE07WEjUMYlKusieGySq2XAmWm4yyqC1TXZi3HriADZwNoXYyLuJq?gv=true" style="border: 0; background: #fff;" width="100%" height="600" frameborder="0"></iframe>
                </div>
                <!-- end Google Calendar Appointment Scheduling -->
            </div>

            <!-- Etapa 3: Observações Adicionais -->
            <div id="step-3" class="form-step hidden">
                <h2 class="text-2xl font-semibold mb-6">Observações</h2>
                <div class="space-y-6">
                    <div>
                        <label for="additionalNotes" class="block text-sm font-medium text-gray-300 mb-1">Observações Adicionais</label>
                        <textarea id="additionalNotes" name="additionalNotes" rows="6" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-teal-500 focus:border-teal-500 transition" placeholder="Alguma informação adicional, necessidade específica, etc."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Container para Mensagens de Erro -->
            <div id="error-message" class="hidden bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Ops!</strong>
                <span class="block sm:inline ml-2" id="error-text"></span>
            </div>

            <div class="mt-10 flex justify-between">
                <button type="button" id="prev-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300 hidden">Voltar</button>
                <button type="button" id="next-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ml-auto">Avançar</button>
                <button type="submit" id="submit-btn" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-6 rounded-lg transition duration-300 hidden">
                    <span class="spinner hidden mr-2"></span>
                    Finalizar Agendamento
                </button>
            </div>
        </form>
        
        <div id="thank-you-message" class="text-center hidden p-8">
            <svg class="mx-auto h-16 w-16 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="text-2xl sm:text-3xl font-bold mt-4">Agendamento Realizado com Sucesso!</h2>
            <p class="text-gray-300 mt-2 max-w-md mx-auto">Obrigado por agendar seu horário conosco. Em breve, você receberá uma confirmação no e-mail informado. Até logo!</p>
        </div>

        <div id="lgpd-note" class="text-center mt-8">
            <p class="text-xs text-gray-500">Seus dados estão seguros. Respeitamos sua privacidade e seguimos a LGPD.</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('booking-form');
            const formContainer = document.getElementById('form-container');
            const thankYouMessage = document.getElementById('thank-you-message');
            const steps = [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')];
            const stepNames = ["Informações", "Horário", "Observações"];
            
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            const progressSection = document.getElementById('progress-section');
            const progressBar = document.getElementById('progress-bar');
            const stepNameEl = document.getElementById('step-name');
            const stepProgressText = document.getElementById('step-progress-text');
            const lgpdNote = document.getElementById('lgpd-note');

            const desiredSpace = document.getElementById('desiredSpace');
            const otherSpaceContainer = document.getElementById('other-space-container');
            const otherSpaceInput = document.getElementById('otherSpace');
            
            const errorMessageContainer = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');

            let currentStep = 0;

            function updateFormView() {
                steps.forEach((step, index) => {
                    step.classList.toggle('hidden', index !== currentStep);
                });

                const progressPercentage = ((currentStep + 1) / steps.length) * 100;
                progressBar.style.width = `${progressPercentage}%`;
                stepNameEl.textContent = `Etapa ${currentStep + 1}: ${stepNames[currentStep]}`;
                stepProgressText.textContent = `${currentStep + 1} / ${steps.length}`;

                prevBtn.classList.toggle('hidden', currentStep === 0);
                nextBtn.classList.toggle('hidden', currentStep === steps.length - 1);
                submitBtn.classList.toggle('hidden', currentStep !== steps.length - 1);
            }

            // Valida apenas a etapa atual (usado para o botão "Avançar")
            function validateCurrentStep() {
                errorMessageContainer.classList.add('hidden');
                if (currentStep === 1) return true;

                const currentStepElement = steps[currentStep];
                const inputs = currentStepElement.querySelectorAll('input[required], select[required]');
                let isValid = true;
                
                for (const input of inputs) {
                    input.classList.remove('border-red-500', 'ring-red-500');
                    let isFieldValid = input.checkValidity();
                    let customErrorMessage = 'Este campo é obrigatório.';

                    if (input.id === 'phone') {
                        const phoneValue = input.value.replace(/\D/g, '');
                        if (phoneValue.length > 0 && phoneValue.length !== 11) {
                            isFieldValid = false;
                            customErrorMessage = 'O telefone deve conter 11 dígitos (DDD + número).';
                        }
                    }
                    
                    if (!isFieldValid) {
                        input.classList.add('border-red-500', 'ring-red-500');
                        errorText.textContent = customErrorMessage;
                        errorMessageContainer.classList.remove('hidden');
                        isValid = false;
                        break; // Para na primeira validação com erro na etapa
                    }
                }
                return isValid;
            }

            // Valida TODAS as etapas (usado para o botão "Finalizar Agendamento")
            function validateAllSteps() {
                errorMessageContainer.classList.add('hidden');
                let firstInvalidInput = null;
                let firstInvalidStep = -1;
                let specificErrorMessage = '';

                for (let i = 0; i < steps.length; i++) {
                    const step = steps[i];
                    if (i === 1) continue; // Pula a validação da etapa do calendário

                    const inputs = step.querySelectorAll('input[required], select[required]');
                    for (const input of inputs) {
                        input.classList.remove('border-red-500', 'ring-red-500');
                        let isFieldValid = input.checkValidity();
                        let customErrorMessage = 'Por favor, preencha todos os campos obrigatórios.';
                        
                        // Validação customizada para o telefone
                        if (input.id === 'phone') {
                            const phoneValue = input.value.replace(/\D/g, '');
                            if (phoneValue.length > 0 && phoneValue.length !== 11) {
                                isFieldValid = false;
                                customErrorMessage = 'O telefone deve conter 11 dígitos (DDD + número).';
                            }
                        }

                        if (!isFieldValid) {
                            if (firstInvalidStep === -1) { // Captura apenas o primeiro erro
                                firstInvalidStep = i;
                                firstInvalidInput = input;
                                specificErrorMessage = customErrorMessage;
                            }
                        }
                    }
                }

                if (firstInvalidStep !== -1) {
                    currentStep = firstInvalidStep;
                    updateFormView();
                    // Revalida a etapa para mostrar os campos em vermelho
                    validateCurrentStep(); 
                    errorText.textContent = specificErrorMessage;
                    errorMessageContainer.classList.remove('hidden');
                    firstInvalidInput.focus();
                    return false;
                }

                return true;
            }


            nextBtn.addEventListener('click', () => {
                if (validateCurrentStep()) {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        updateFormView();
                    }
                }
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    updateFormView();
                }
            });
            
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                errorMessageContainer.classList.add('hidden');

                if (validateAllSteps()) {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

                    const formData = new FormData(form);
                    const flatData = Object.fromEntries(formData.entries());

                    const organizedData = {
                        solicitante: {
                            fullName: flatData.fullName,
                            phone: flatData.phone,
                            email: flatData.email,
                            ministry: flatData.ministry || ''
                        },
                        responsavel: {
                            responsibleEmail: flatData.responsibleEmail
                        },
                        reserva: {
                            desiredSpace: flatData.desiredSpace,
                            additionalNotes: flatData.additionalNotes || ''
                        }
                    };

                    if (flatData.desiredSpace === 'Outro') {
                        organizedData.reserva.otherSpace = flatData.otherSpace || 'Não especificado';
                    }

                    try {
                        const webhookURL = 'https://eolg5hbpio35vyr.m.pipedream.net';
                        
                        const response = await fetch(webhookURL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(organizedData)
                        });
                        
                        if (!response.ok) {
                            const responseText = await response.text();
                            throw new Error(`O servidor respondeu com status ${response.status}. Resposta: ${responseText}`);
                        }
                        
                        // Esconde o formulário e mostra a mensagem de agradecimento
                        document.getElementById('form-container').classList.add('hidden');
                        document.getElementById('thank-you-message').classList.remove('hidden');
                        document.getElementById('lgpd-note').classList.add('hidden');


                    } catch (e) {
                        console.error('Erro ao enviar dados para o webhook:', e);
                        errorText.textContent = e.message || 'Não foi possível enviar o agendamento. Verifique sua conexão e tente novamente.';
                        errorMessageContainer.classList.remove('hidden');
                        
                        submitBtn.disabled = false;
                        submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            });

            desiredSpace.addEventListener('change', () => {
                if (desiredSpace.value === 'Outro') {
                    otherSpaceContainer.classList.remove('hidden');
                    otherSpaceInput.required = true;
                } else {
                    otherSpaceContainer.classList.add('hidden');
                    otherSpaceInput.required = false;
                    otherSpaceInput.value = '';
                }
            });

            updateFormView();
        });
    </script>
</body>
</html>
